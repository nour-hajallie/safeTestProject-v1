import React from 'react';
import { SuiteStatuses } from './suite';
import { ComponentsContext, StateContext } from './report';
const createNestedSuite = (file) => {
    const filename = file.filename;
    const suitesById = {};
    const statuses = {};
    const suites = {};
    const tests = {};
    const fileSuite = { id: filename, name: filename, suites, tests };
    for (const result of file.assertionResults) {
        const { ancestorTitles, title } = result;
        let suite = fileSuite;
        for (const ancestorTitle of ancestorTitles) {
            const id = `${suite.id} > ${ancestorTitle}`;
            if (!suite.suites[ancestorTitle]) {
                const name = ancestorTitle;
                const newSuite = { id, name, suites: {}, tests: {}, parent: suite };
                suitesById[id] = newSuite;
                suite.suites[ancestorTitle] = newSuite;
            }
            suite = suite.suites[ancestorTitle];
        }
        const id = `${suite.id} > ${result.title}`;
        const test = { ...result, id, parent: suite };
        suite.tests[title] = test;
        statuses[id] = test.status;
    }
    // const grouped: Partial<Record<Status, string[]>> = {};
    // for (const [id, status] of Object.entries(statuses)) {
    //   (grouped[status] ??= []).push(id);
    // }
    return {
        filename,
        suite: fileSuite,
        suiteIds: Object.keys(suitesById),
        statuses,
    };
};
export const File = ({ file }) => {
    const suite = React.useMemo(() => createNestedSuite(file), [file]);
    const { Accordion, Suite } = React.useContext(ComponentsContext);
    const showing = React.useContext(StateContext).viewing;
    let isViewing = false;
    for (const status of Object.values(suite.statuses)) {
        if (showing === 'all' || showing === status) {
            isViewing = true;
            break;
        }
    }
    if (!isViewing)
        return null;
    return (React.createElement(Accordion, { summary: React.createElement(React.Fragment, null,
            React.createElement(SuiteStatuses, { suite: suite.suite }),
            " ",
            suite.filename), defaultOpen: true },
        React.createElement(Suite, { suite: suite.suite })));
};
